# Nginx 설정 예시 - /etc/nginx/sites-available/proletariat.r-e.kr

server {
    listen 443 ssl http2;
    server_name proletariat.r-e.kr;

    # SSL 설정 (Let's Encrypt 등)
    # ssl_certificate /path/to/cert.pem;
    # ssl_certificate_key /path/to/key.pem;

    # Next.js 앱 (메인)
    location / {
        proxy_pass http://host.docker.internal:52000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API 서버 (백엔드)
    location /api/ {
        proxy_pass http://host.docker.internal:51000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API 문서
    location /docs/ {
        proxy_pass http://host.docker.internal:51000/docs/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ⚠️ 중요: /assets/ 경로도 Next.js로 프록시해야 함!
    # Next.js의 public 폴더가 /assets/로 서빙되기 때문 (폰트, 로컬 이미지 등)
    location /assets/ {
        proxy_pass http://host.docker.internal:52000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 정적 파일 캐싱
        proxy_cache_valid 200 30d;
        proxy_cache_bypass $http_pragma $http_authorization;
        add_header Cache-Control "public, max-age=2592000";
    }

    # 백엔드에서 업로드한 실제 파일들 (이미지, 영상 등)
    # DB에 저장된 경로: assets/180/xxx.png
    # 최종 URL: /uploads/assets/180/xxx.png
    # Nginx 볼륨: /Users/seohae/workspace/archive-stardew-velley/assets:/usr/share/nginx/html/uploads:ro
    location /uploads/ {
        alias /usr/share/nginx/html/uploads/;
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
        try_files $uri $uri/ =404;
    }

    # Next.js의 _next 정적 파일들 (최적화된 캐싱)
    location /_next/static/ {
        proxy_pass http://host.docker.internal:52000;
        proxy_cache_valid 200 365d;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }
}

# HTTP to HTTPS 리다이렉트
server {
    listen 80;
    server_name proletariat.r-e.kr;
    return 301 https://$server_name$request_uri;
}
